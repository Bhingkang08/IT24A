<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/styles.css">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>
<body>
    <div class="explore-page" style="display: block; margin-top: -15px;">
        <!-- Map container -->
        <div id="map" style="width: 100%; height: 45%;"></div>

        <!-- Information panel for selected destination -->
        <div id="info-panel" style="width: 120%;">
            <div class="walu-container"></div>
        </div>

        <!-- Attendance Button -->
        <div style="margin: 10px; text-align: center;">
            <button id="attendance-btn" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">
                Mark Attendance
            </button>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Initialize the map centered on waku waku, Kisolon, Bukidnon
        var map = L.map('map').setView([8.3674, 124.8666], 12);

        // Load and display OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Function to update the info panel
        function updateInfoPanel(title, description, imageUrl, lat, lng) {
            var infoPanel = document.getElementById('info-panel');
            infoPanel.innerHTML = `
                <h2 style='font-size: 14px;'>${title}</h2>
                <img src="${imageUrl}" style="width: 150px; height: 150px;" alt="${title}">
                <p style="font-size: 12px;">${description}</p>
                <a style="margin-top: -5px;" class="btn btn-warning" href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank">Get Directions</a>
            `;
        }

        var locations = [
            { title: "Flame Tea - Manolo Fortich Branch", position: [8.367457641739026, 124.86681943293729], description: "DAGHAN LAMI!", imageUrl: "assets/images/P3.JPG" },
            { title: "Lazy Cow Milk Tea Cafe", position: [8.3678466865564, 124.86554410184262], description: "PAIT PAIT GAMAY!", imageUrl: "assets/images/2019-12-21.jpg" },
            { title: "Don Macchiatos-Tankulan, Manolo Fortich", position: [8.367776648460074, 124.86366542312875], description: "TAM-is RA KAAYU UY.", imageUrl: "assets/images/dm-tankulan3.png" },
            { title: "Golden Trumpet Cafe", position: [8.369964580947915, 124.86078456034527], description: "AMBOT NALNG JUD.", imageUrl: "assets/images/2022-01-04.jpg" },
            { title: "Riley's Cafe", position: [8.370665141318657, 124.85803797845647], description: "SAMOT KA AMBOT JUD!.", imageUrl: "assets/images/2021-11-02.jpg" },
            { title: "Centro Coffee", position: [8.3131, 124.9595], description: " HEHEHE.", imageUrl: "assets/images/coffee5.jpg" },
            { title: "Chavez Milktea Shoppe", position: [8.377690577741424, 124.84790030149453], description: "SUS HAHAHA.", imageUrl: "assets/images/p3.jpg" }
        ];

        // Walu Icon
        const waluIcon = L.divIcon({
            html: `
                <div style="position: relative; text-align: center;">
                    <img src="WAVING/W1.png" style="width: 100px; height: 100px;">
                    <!-- Make sure the attendance count is above and fixed in place -->
                    <div id="attendance-count" style="position: absolute; top: 0; right: 10px; background-color: red; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">0</div>
                </div>
            `,
            iconSize: [100, 100],
            className: ''
        });

        // Initialize attendance count
        let attendanceCount = 0;
        let waving = true;  // Flag to prevent multiple animations

        // Placeholder for Walu marker
        let waluMarker = L.marker([8.3674, 124.8666], { icon: waluIcon }).addTo(map);

        // Function to animate Walu's movement
        function moveWalu(fromPosition, toPosition, duration = 1000) {
            if (!waluMarker) {
                // Create Walu marker at starting position if it doesn't exist yet
                waluMarker = L.marker(fromPosition, { icon: waluIcon }).addTo(map);
                startWavingAnimation(); // Start waving when Walu is placed on the map
            }

            let startTime = null;

            function animate(time) {
                if (!startTime) startTime = time;
                let elapsed = time - startTime;
                let progress = Math.min(elapsed / duration, 1); // Progress from 0 to 1

                // Interpolate Walu's position between fromPosition and toPosition
                let currentLat = fromPosition[0] + (toPosition[0] - fromPosition[0]) * progress;
                let currentLng = fromPosition[1] + (toPosition[1] - fromPosition[1]) * progress;

                // Move Walu to the current interpolated position
                waluMarker.setLatLng([currentLat, currentLng]);

                // If the animation is not finished, continue
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }

            // Start the animation
            requestAnimationFrame(animate);
        }

        // Function to start the waving animation
        function startWavingAnimation() {
            if (waving) return; // Prevent multiple animations if already waving
            console.log("Starting waving animation..."); // Debugging log
            waving = true;

            let toggle = true; // Toggle between the two images (W1.png and W2.png)

            // Set interval to toggle between images for the waving effect
            setInterval(() => {
                if (waluMarker) {
                    // Alternate between W1.png and W2.png for waving effect
                    let iconUrl = toggle ? 'WAVING/W1.png' : 'WAVING/W2.png';
                    console.log("Toggling icon: " + iconUrl); // Debugging log
                    
                    // Update the icon of the waluMarker with the new image
                    waluMarker.setIcon(L.icon({
                        iconUrl: iconUrl,
                        iconSize: [100, 100], // Set size of the icon
                        iconAnchor: [50, 50], // Set the anchor point of the icon
                    }));
                    
                    // Toggle the icon state
                    toggle = !toggle; // Switch between W1.png and W2.png
                }
            }, 500); // Change image every 500ms for the waving effect
        }

        // Call the startWavingAnimation immediately when the page loads
        startWavingAnimation();

        // Attendance button event listener
        document.getElementById('attendance-btn').addEventListener('click', function () {
            attendanceCount++;
            document.getElementById('attendance-count').textContent = attendanceCount;
        });

        // Loop through locations and add markers
        locations.forEach(function(location) {
            var marker = L.marker(location.position).addTo(map);

            marker.on('click', function() {
                // Reset the attendance count when a new location is selected
                attendanceCount = 0;
                document.getElementById('attendance-count').textContent = attendanceCount;

                // Center the map on the marker and zoom in
                map.setView(location.position, 14);

                // Update the info panel
                updateInfoPanel(location.title, location.description, location.imageUrl, location.position[0], location.position[1]);

                // Animate Walu's movement to the clicked location
                if (waluMarker) {
                    let currentPosition = waluMarker.getLatLng(); // Get current position
                    moveWalu([currentPosition.lat, currentPosition.lng], location.position); // Animate movement to new location
                }
            });
        });
    </script>
</body>
</html>
